{% extends 'layout.html' %}
{% block title %}Ektrasi Fitur TF-IDF{% endblock %}
{% block content %}
<div class="main-content">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800"> 

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Perbandingan Ekstraksi Fitur</h1>
            <p class="text-gray-600 mt-1">Bandingkan hasil ekstraksi fitur TF-IDF dengan dan tanpa penyeimbangan data SMOTE.</p>
        </header>

        <div class="flex flex-wrap gap-4 mb-8">
            <button id="tfidf-only-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M10 12a2 2 0 100-4 2 2 0 000 4z" /><path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.27 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd" /></svg>
                Jalankan TF-IDF Saja
            </button>
            <button id="tfidf-smote-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM11 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                Jalankan TF-IDF + SMOTE
            </button>
            <button id="delete-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Hapus Hasil
            </button>
        </div>

        <div id="results-container" class="hidden">
            <h2 id="result-title" class="text-2xl font-semibold mb-4 text-gray-800">Hasil Proses</h2>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <div id="success-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">Total Data Diproses</h3><p class="text-3xl font-bold text-gray-900" id="total-data">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">Data Latih (Sebelum SMOTE)</h3><p class="text-3xl font-bold text-orange-500" id="train-before">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">Data Uji</h3><p class="text-3xl font-bold text-purple-600" id="test-data">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">Data Latih (Setelah Proses)</h3><p class="text-3xl font-bold text-green-600" id="train-after">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">Data Sintetis Ditambahkan</h3><p class="text-3xl font-bold text-teal-500" id="smote-added">-</p></div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-sm font-medium text-gray-500">Jumlah Fitur (TF-IDF)</h3><p class="text-3xl font-bold text-indigo-600" id="feature-count">-</p></div>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200"><h3 class="text-lg font-semibold text-gray-700 mb-4">Distribusi Data Latih</h3><canvas id="smote-chart"></canvas></div>
            </div>
        </div>

        <div id="loading-indicator" class="hidden flex flex-col items-center justify-center mt-10">
            <div class="spinner w-12 h-12 rounded-full border-4 border-gray-300"></div>
            <p class="mt-4 text-gray-600">Sedang memproses, mohon tunggu...</p>
        </div>
    </div>

    <script>
    let smoteChart = null;

    function renderResults(data, title) {
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        const errorContainer = document.getElementById('error-message');
        const successContent = document.getElementById('success-content');
        const resultTitle = document.getElementById('result-title');

        loadingIndicator.classList.add('hidden');
        resultsContainer.classList.remove('hidden');
        resultTitle.textContent = title;

        if (data.success) {
            successContent.classList.remove('hidden');
            errorContainer.classList.add('hidden');
            const stats = data.stats;
            document.getElementById('total-data').textContent = stats.total_data;
            document.getElementById('train-before').textContent = stats.train_data_count_before;
            document.getElementById('train-after').textContent = stats.train_data_count_after;
            document.getElementById('test-data').textContent = stats.test_data_count;
            document.getElementById('smote-added').textContent = `+${stats.smote_added_count}`;
            document.getElementById('feature-count').textContent = stats.feature_count;
            renderOrUpdateChart(stats);
        } else {
            document.getElementById('error-text').textContent = data.error || 'Terjadi kesalahan.';
            errorContainer.classList.remove('hidden');
            successContent.classList.add('hidden');
        }
    }

    async function runExtraction(useSmote, title) {
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        
        loadingIndicator.classList.remove('hidden');
        resultsContainer.classList.add('hidden');

        try {
            const response = await fetch("{{ url_for('proses_ekstraksi_route') }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ use_smote: useSmote })
            });

            const data = await response.json();
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            }
            
            // Simpan hasil ke session storage untuk persistensi
            sessionStorage.setItem('extractionResult', JSON.stringify(data));
            sessionStorage.setItem('extractionTitle', title);

            renderResults(data, title);

        } catch (error) {
            const errorData = { success: false, error: 'Gagal terhubung ke server: ' + error.message };
            renderResults(errorData, 'Error');
        }
    }

    async function deleteResults() {
        if (!confirm('Apakah Anda yakin ingin menghapus hasil ekstraksi sebelumnya?')) {
            return;
        }
        try {
            const response = await fetch("{{ url_for('hapus_ekstraksi_route') }}", { method: 'POST' });
            const result = await response.json();
             if (!response.ok) {
                throw new Error(result.message || 'Gagal menghapus hasil.');
            }
            // Hapus dari session storage dan sembunyikan hasil
            sessionStorage.removeItem('extractionResult');
            sessionStorage.removeItem('extractionTitle');
            document.getElementById('results-container').classList.add('hidden');
            alert(result.message); // Notifikasi sederhana
        } catch(error) {
            alert('Error: ' + error.message);
        }
    }

    // Event listener untuk tombol-tombol
    document.getElementById('tfidf-only-btn').addEventListener('click', () => runExtraction(false, 'Hasil Proses: TF-IDF Saja'));
    document.getElementById('tfidf-smote-btn').addEventListener('click', () => runExtraction(true, 'Hasil Proses: TF-IDF + SMOTE'));
    document.getElementById('delete-btn').addEventListener('click', deleteResults);

    // Memeriksa sessionStorage saat halaman dimuat untuk menampilkan hasil terakhir
    document.addEventListener('DOMContentLoaded', function() {
        const storedDataJSON = sessionStorage.getItem('extractionResult');
        const storedTitle = sessionStorage.getItem('extractionTitle');
        if (storedDataJSON && storedTitle) {
            const storedData = JSON.parse(storedDataJSON);
            renderResults(storedData, storedTitle);
        }
    });

    // Fungsi untuk render chart
    function renderOrUpdateChart(stats) {
        const ctx = document.getElementById('smote-chart').getContext('2d');
        const labels = Object.keys(stats.distribution_before).sort();
        const dataBefore = labels.map(label => stats.distribution_before[label]);
        const dataAfter = labels.map(label => stats.distribution_after[label]);

        if (smoteChart) {
            smoteChart.data.labels = labels;
            smoteChart.data.datasets[0].data = dataBefore;
            smoteChart.data.datasets[1].data = dataAfter;
            smoteChart.update();
        } else {
            smoteChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sebelum Proses',
                        data: dataBefore,
                        backgroundColor: 'rgba(255, 159, 64, 0.5)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 1
                    }, {
                        label: 'Setelah Proses',
                        data: dataAfter,
                        backgroundColor: 'rgba(75, 192, 192, 0.5)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true, title: { display: true, text: 'Jumlah Data' } } }, responsive: true, plugins: { legend: { position: 'top' }, tooltip: { mode: 'index', intersect: false } } }
            });
        }
    }
</script>
</div>
{% endblock %}
