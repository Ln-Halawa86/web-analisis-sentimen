{% extends 'layout.html' %}
{% block title %}Pelatihan & Evaluasi Model{% endblock %}
{% block content %}
<div class="main-content">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .spinner { border-top-color: #3498db; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .cm-table { border-collapse: separate; border-spacing: 0; }
        .cm-table th, .cm-table td { border: 1px solid #e2e8f0; padding: 0.75rem; text-align: center; }
        .cm-table .header-cell { background-color: #f8fafc; font-weight: 600; }
        .cm-table .diagonal { background-color: #dcfce7; color: #166534; }
        .cm-table .off-diagonal { background-color: #fee2e2; color: #991b1b; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Pelatihan & Evaluasi Model Naive Bayes</h1>
            <p class="text-gray-600 mt-1">Latih model menggunakan data hasil ekstraksi fitur dan lihat perbandingan performanya.</p>
        </header>

        <div class="flex flex-wrap gap-4 mb-8">
            <button id="train-tfidf-btn" class="bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-indigo-700 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Latih dengan TF-IDF Saja
            </button>
            <button id="train-smote-btn" class="bg-teal-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-teal-700 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                Latih dengan TF-IDF + SMOTE
            </button>
            <button id="delete-results-btn" class="bg-red-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-700 transition duration-300 flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                Hapus Hasil Pelatihan
            </button>
        </div>

        <div id="results-container" class="hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 id="result-title" class="text-2xl font-semibold text-gray-800">Hasil Evaluasi Model</h2>
                <button id="toggle-metrics-btn" class="text-gray-500 hover:text-gray-800 focus:outline-none" title="Tampilkan/Sembunyikan Metrik">
                    <svg id="eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.27 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                    </svg>
                    <svg id="eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                    </svg>
                </button>
            </div>
            
            <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative mb-6" role="alert">
                <strong class="font-bold">Error!</strong>
                <span class="block sm:inline" id="error-text"></span>
            </div>

            <div id="success-content">
                <div id="metrics-grid" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-blue-500 text-white p-6 rounded-lg shadow-lg"><h3 class="text-sm font-medium opacity-80">Akurasi</h3><p class="text-4xl font-bold" id="accuracy-val">-</p></div>
                    <div class="bg-green-500 text-white p-6 rounded-lg shadow-lg"><h3 class="text-sm font-medium opacity-80">Rata-rata Presisi</h3><p class="text-4xl font-bold" id="precision-val">-</p></div>
                    <div class="bg-yellow-500 text-white p-6 rounded-lg shadow-lg"><h3 class="text-sm font-medium opacity-80">Rata-rata Recall</h3><p class="text-4xl font-bold" id="recall-val">-</p></div>
                </div>

                <div class="mt-8 bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-700">Hasil Prediksi pada Data Uji</h3>
                        <button id="toggle-predictions-btn" class="text-gray-500 hover:text-gray-800 focus:outline-none" title="Tampilkan/Sembunyikan Hasil Prediksi">
                            <svg id="pred-eye-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                              <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.27 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <svg id="pred-eye-slash-icon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                              <path stroke-linecap="round" stroke-linejoin="round" d="M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21" />
                            </svg>
                        </button>
                    </div>
                    <div id="predictions-table-container" class="overflow-y-auto h-96 border rounded-lg">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 sticky top-0">
                                <tr>
                                    <th scope="col" class="px-6 py-3">#</th>
                                    <th scope="col" class="px-6 py-3">Teks Uji (Hasil Stemming)</th>
                                    <th scope="col" class="px-6 py-3">Sentimen Aktual</th>
                                    <th scope="col" class="px-6 py-3">Sentimen Prediksi</th>
                                    <th scope="col" class="px-6 py-3 text-center">Hasil</th>
                                </tr>
                            </thead>
                            <tbody id="predictions-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- PERUBAHAN: Layout diubah menjadi grid 2 kolom -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Laporan Klasifikasi Rinci</h3>
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr><th scope="col" class="px-6 py-3">Kelas</th><th scope="col" class="px-6 py-3">Precision</th><th scope="col" class="px-6 py-3">Recall</th><th scope="col" class="px-6 py-3">F1-Score</th><th scope="col" class="px-6 py-3">Support</th></tr>
                            </thead>
                            <tbody id="report-body"></tbody>
                        </table>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-700 mb-4">Matriks Kebingungan (Confusion Matrix)</h3>
                        <div id="cm-container" class="overflow-x-auto"></div>
                    </div>
                </div>

               

            </div>
        </div>

        <div id="loading-indicator" class="hidden flex flex-col items-center justify-center mt-10">
            <div class="spinner w-12 h-12 rounded-full border-4 border-gray-300"></div>
            <p class="mt-4 text-gray-600">Sedang melatih & mengevaluasi model, ini mungkin memakan waktu lama...</p>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const toggleMetricsBtn = document.getElementById('toggle-metrics-btn');
        const metricsGrid = document.getElementById('metrics-grid');
        const eyeIcon = document.getElementById('eye-icon');
        const eyeSlashIcon = document.getElementById('eye-slash-icon');
        let areMetricsVisible = true;

        const togglePredictionsBtn = document.getElementById('toggle-predictions-btn');
        const predictionsTableContainer = document.getElementById('predictions-table-container');
        const predEyeIcon = document.getElementById('pred-eye-icon');
        const predEyeSlashIcon = document.getElementById('pred-eye-slash-icon');
        let arePredictionsVisible = true;

        function renderResults(data, title) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsContainer = document.getElementById('results-container');
            const errorContainer = document.getElementById('error-message');
            const successContent = document.getElementById('success-content');
            const resultTitle = document.getElementById('result-title');

            loadingIndicator.classList.add('hidden');
            resultsContainer.classList.remove('hidden');
            resultTitle.textContent = title;

            if (data.success) {
                successContent.classList.remove('hidden');
                errorContainer.classList.add('hidden');
                
                metricsGrid.classList.remove('hidden');
                areMetricsVisible = true;
                eyeIcon.classList.remove('hidden');
                eyeSlashIcon.classList.add('hidden');

                predictionsTableContainer.classList.remove('hidden');
                arePredictionsVisible = true;
                predEyeIcon.classList.remove('hidden');
                predEyeSlashIcon.classList.add('hidden');

                document.getElementById('accuracy-val').textContent = (data.accuracy * 100).toFixed(2) + '%';
                document.getElementById('precision-val').textContent = data.classification_report['macro avg']['precision'].toFixed(2);
                document.getElementById('recall-val').textContent = data.classification_report['macro avg']['recall'].toFixed(2);

                const reportBody = document.getElementById('report-body');
                reportBody.innerHTML = '';
                data.labels.forEach(label => {
                    const metrics = data.classification_report[label];
                    const row = `<tr class="bg-white border-b"><th scope="row" class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${label}</th><td class="px-6 py-4">${metrics.precision.toFixed(2)}</td><td class="px-6 py-4">${metrics.recall.toFixed(2)}</td><td class="px-6 py-4">${metrics['f1-score'].toFixed(2)}</td><td class="px-6 py-4">${metrics.support}</td></tr>`;
                    reportBody.innerHTML += row;
                });

                const cmContainer = document.getElementById('cm-container');
                let cmTable = '<table class="w-full cm-table"><thead><tr><th class="header-cell"></th><th colspan="'+data.labels.length+'" class="header-cell">Prediksi</th></tr><tr><th class="header-cell">Aktual</th>';
                data.labels.forEach(label => cmTable += `<th class="header-cell">${label}</th>`);
                cmTable += '</tr></thead><tbody>';
                data.confusion_matrix.forEach((row, i) => {
                    cmTable += `<tr><th class="header-cell">${data.labels[i]}</th>`;
                    row.forEach((val, j) => {
                        const cellClass = i === j ? 'diagonal' : 'off-diagonal';
                        cmTable += `<td class="${cellClass}">${val}</td>`;
                    });
                    cmTable += '</tr>';
                });
                cmTable += '</tbody></table>';
                cmContainer.innerHTML = cmTable;

                const predictionsBody = document.getElementById('predictions-body');
                predictionsBody.innerHTML = '';
                if (data.prediction_results && Array.isArray(data.prediction_results)) {
                    data.prediction_results.forEach((item, index) => {
                        const isCorrect = item.actual === item.predicted;
                        const resultIcon = isCorrect 
                            ? '<span class="text-green-600 font-semibold">✓ Benar</span>' 
                            : '<span class="text-red-600 font-semibold">✗ Salah</span>';
                        
                        const row = `
                            <tr class="bg-white border-b hover:bg-gray-50">
                                <td class="px-6 py-4 text-gray-500">${index + 1}</td>
                                <td class="px-6 py-4">${item.text}</td>
                                <td class="px-6 py-4 font-medium text-gray-900">${item.actual}</td>
                                <td class="px-6 py-4 font-medium text-gray-900">${item.predicted}</td>
                                <td class="px-6 py-4 text-center">${resultIcon}</td>
                            </tr>`;
                        predictionsBody.innerHTML += row;
                    });
                }

            } else {
                document.getElementById('error-text').textContent = data.error || 'Terjadi kesalahan.';
                errorContainer.classList.remove('hidden');
                successContent.classList.add('hidden');
            }
        }

        async function runTraining(useSmote, title) {
            const loadingIndicator = document.getElementById('loading-indicator');
            const resultsContainer = document.getElementById('results-container');
            
            loadingIndicator.classList.remove('hidden');
            resultsContainer.classList.add('hidden');

            try {
                const response = await fetch("{{ url_for('latih_dan_evaluasi_route') }}", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ use_smote: useSmote })
                });

                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.error || `HTTP error! status: ${response.status}`);
                }

                sessionStorage.setItem('trainingResult', JSON.stringify(data));
                sessionStorage.setItem('trainingTitle', title);

                renderResults(data, title);

            } catch (error) {
                const errorData = { success: false, error: 'Gagal terhubung ke server: ' + error.message };
                renderResults(errorData, 'Error');
            }
        }

        async function deleteTrainingResults() {
            if (!confirm('Apakah Anda yakin ingin menghapus semua hasil pelatihan dari database?')) {
                return;
            }
            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');

            try {
                const response = await fetch("{{ url_for('hapus_hasil_pelatihan') }}", { method: 'POST' });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Gagal menghapus hasil.');
                }

                sessionStorage.removeItem('trainingResult');
                sessionStorage.removeItem('trainingTitle');

                document.getElementById('results-container').classList.add('hidden');
                alert(result.message);
            } catch(error) {
                alert('Error: ' + error.message);
            } finally {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Event listener untuk tombol-tombol
        document.getElementById('train-tfidf-btn').addEventListener('click', () => runTraining(false, 'Hasil Evaluasi: TF-IDF Saja'));
        document.getElementById('train-smote-btn').addEventListener('click', () => runTraining(true, 'Hasil Evaluasi: TF-IDF + SMOTE'));
        document.getElementById('delete-results-btn').addEventListener('click', deleteTrainingResults);
        
        toggleMetricsBtn.addEventListener('click', () => {
            areMetricsVisible = !areMetricsVisible;
            metricsGrid.classList.toggle('hidden', !areMetricsVisible);
            eyeIcon.classList.toggle('hidden', !areMetricsVisible);
            eyeSlashIcon.classList.toggle('hidden', areMetricsVisible);
        });

        togglePredictionsBtn.addEventListener('click', () => {
            arePredictionsVisible = !arePredictionsVisible;
            predictionsTableContainer.classList.toggle('hidden', !arePredictionsVisible);
            predEyeIcon.classList.toggle('hidden', !arePredictionsVisible);
            predEyeSlashIcon.classList.toggle('hidden', arePredictionsVisible);
        });
        
        const storedDataJSON = sessionStorage.getItem('trainingResult');
        const storedTitle = sessionStorage.getItem('trainingTitle');
        if (storedDataJSON && storedTitle) {
            const storedData = JSON.parse(storedDataJSON);
            renderResults(storedData, storedTitle);
        }
    });
    </script>
</div>
{% endblock %}
